---
- hosts: localhost
  connection: local
  roles:
    - lae.travis-lxc
  tasks:
    - name: Create SSL directory for storing secrets
      file:
        dest: "{{ ssl_directory }}"
        state: directory
    - name: Create Root CA private key
      shell: "openssl genrsa -out {{ ssl_ca_key_path }} 2048"
    - name: Create Root CA certificate
      shell: "openssl req -x509 -new -nodes -key {{ ssl_ca_key_path }} -sha256 -days 1 -subj '{{ ssl_subj }}' -out {{ ssl_ca_cert_path }}"
  vars:
    test_profiles:
      - profile: debian-stretch
        prefix: proxmox-5-
    test_hosts_per_profile: 3
    container_config:
      - "lxc.apparmor.profile = unconfined"
      - "lxc.mount.auto = proc:rw sys:rw cgroup-full:rw"
      - "lxc.cgroup.devices.allow = a *:* rmw"
      - "lxc.mount.entry = /lib/modules/{{ ansible_kernel }} lib/modules/{{ ansible_kernel }} none bind,create=dir,ro 0 0"

# Run the following within the containers in the inventory
- hosts: all
  tasks:
    - name: Create FUSE device within containers
      command: "mknod -m 666 /dev/fuse c 10 229"
      args:
        creates: /dev/fuse
    - name: Install Root CA certificate
      copy:
        src: "{{ ssl_ca_cert_path }}"
        dest: /usr/local/share/ca-certificates/test-ca.crt
      become: True
    - name: Insert bogus lines in /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
      with_items:
        - "127.0.1.1    {{ ansible_fqdn }} {{ ansible_hostname }}"
        - "10.22.33.44    {{ ansible_hostname }} {{ ansible_fqdn }}"
    - name: Update CA certificate store
      shell: update-ca-certificates
      become: True
    - block:
      - name: Create host SSL private key
        shell: "openssl genrsa -out {{ ssl_host_key_path }} 2048"
      - name: Create host SSL certificate signing request
        shell: "openssl req -new -key {{ ssl_host_key_path }} -subj '{{ ssl_subj }}' -out {{ ssl_host_csr_path }}"
      - name: Create host SSL certificate
        shell: "openssl x509 -req -in {{ ssl_host_csr_path }} -CA {{ ssl_ca_cert_path }} -CAkey {{ ssl_ca_key_path }} -days 1 -CAcreateserial -sha256 -out {{ ssl_host_cert_path }}"
      delegate_to: localhost

    - name: Create sparse files for loop block devices
      command: "truncate -s 50G /tmp/osd{{ item }}.img"
      args:
        creates: "/tmp/osd{{ item }}.img"
      with_items: [0, 1]

    - name: Create loop devices nodes
      command: "mknod -m 660 /dev/{{ item.name }} {{ item.type }} {{ item.major }} {{ item.minor }}"
      args:
        creates: "/dev/{{ item.name }}"
      with_items:
        - name: loop0
          type: b
          major: 7
          minor: 0
        - name: loop1
          type: b
          major: 7
          minor: 0
        - name: loop-control
          type: c
          major: 10
          minor: 237

    - name: Map loop block devices for Ceph OSDs
      command: "losetup /dev/loop{{ item }} /tmp/osd{{ item }}.img"
      with_items: [0, 1]
